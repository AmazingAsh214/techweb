% Linux 

# Hardware

## Know your hardware

 Before you struggle opening the box or finding the adequate screwdriver, you can try out the following:


List hardware: `lshw` or `inxi -Fxz`
For example:

- Network: `lshw -C network`
- Hard disks: `lshw -C disk`

Product model:
```
$ inxi -M
Machine:   System: xxx product: xxx v: 01
           Mobo: xxx v: x Bios: xx v: xx date: xx/xx/xxxx
```
    or
```
sudo dmidecode -t baseboard | grep -i 'Product'
```


List RAM: `sudo dmidecode -t memory`

List PCI devices: `lspci`.
For example, get the video card:
```
$ lspci -vnn | grep VGA -A 12
```

- list USB devices: lsusb
- list block devices: lsblk
- list SCSI devices (useful for SATA disks): `cat /proc/scsi/scsi` or `lsscsi`

## Get hard disk info

`sudo hdparm -i /dev/sda`


## Setting keyboard layout

`setxkbmap -layout fr`

# System

## Services

[Create a service with Systemd](https://doc.ubuntu-fr.org/creer_un_service_avec_systemd)

Example for Junior CTF using CTFd platform:

```
# cat ctfd.service 
[Unit]
Description=Capture The Flag server (CTFd)
After=network-online.target

[Service]
Type=simple
User=root
Group=root
ExecStart=/usr/bin/python /usr/share/CTFd/serve.py &
Restart=on-failure
TimeoutStopSec=300

[Install]
WantedBy=multi-user.target


$ cat ctfd-docker.service 
[Unit]
Description=Docker containers for challenges of Junior CTF
After=ctfd.service

[Service]
Type=oneshot
User=axelle
Group=axelle
RemainAfterExit=yes
ExecStart=/bin/bash /home/axelle/juniorctf/up.sh
ExecStop=/bin/bash /home/axelle/juniorctf/down.sh

[Install]
WantedBy=multi-user.target
```

If you want a service that runs periodically, then use a **timer** (which is a special service) (or use crontab). [This explains how to create a timer](https://www.linuxtricks.fr/wiki/systemd-creer-des-services-timers-unites) (in French).

Basically,

1. Create a service file. The service file dictates the executable to run and in which conditions.
2. Create a timer file (extension .timer) to explain how frequently to run the service.
3. Installer the service and timer files to `/lib/systemd/system`
4. Reload: `sudo systemctl daemon-reload`
5. Enable and then activate the timer: `sudo systemctl enable/start xxx.timer`

Example: the service file:

```
[Unit]
Description=Allows kid to log only at certain times of the day
After=graphical.target

[Service]
Type=oneshot
ExecStart=/home/xx/scripts/parentalcontrol.sh

[Install]
WantedBy=multi-user.target
```

The timer file:

```
[Unit]
Description=Allows kid to log only at certain times of the day


[Timer]
OnUnitActiveSec=5min

[Install]
WantedBy=multi-user.target
```



## Network

### Interfaces

```bash 
$ sudo ifconfig <interface> <address> netmask <mask>
```

or with the `ip` syntax use commands such as:

- `ip link set eth0 down`
- `ip address add 192.168.0.77 dev eth0`


### Routes

```bash
ip route show
ip route add 10.20.0.0/24 dev rndis0
ip route add default via 10.20.30.1
```

### Name resolution

In recent Linux Mint / Ubuntu distribution, you no longer directly edit /etc/resolv.conf to specify your name server as the file's header says:

```bash
# Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
```

Instead, you specify name servers in /etc/resolvconf/resolv.conf.d/base
```bash
$ cat /etc/resolvconf/resolv.conf.d/base
nameserver 4.2.2.2
nameserver 8.8.8.8
nameserver 8.8.4.4
```

If there are some name servers you want to favour, then, you need to put them
in `/etc/resolvconf/resolv.conf.d/head`.

Once this is done, you need to update name resolution with the command `resolvconf -u`.

### Troubleshooting

I had issues with my Ethernet link. In my case, it was solved by commenting out dns=dnsmasq in NetworkManager:

```
[main]
plugins=ifupdown,keyfile,ofono
#dns=dnsmasq

[ifupdown]
managed=false
```

### Wireless

Get your SSID: `iwgetid`

### IPv6

In /etc/sysctl.conf

```
# Disable IPv6
net.ipv6.conf.all.disable_ipv6 = 1
```

### mDNS

*"Avahi is a Linux implementation of Zero Configuration Networking ( Zeroconf ) which implements muticast DNS ( mDNS ) allowing ip address to hostname resolution without the use of standard LAN side DNS services."*

To install it: `sudo apt-get install libnss-mdns`. And ensure that `/etc/nsswitch.conf` has mDNS mentioned:

```
hosts:          files mdns4_minimal [NOTFOUND=return] dns mdns4
```


- avahi requires that port 5353/udp is open.
- To find all IPv4 services on the internal network: ` avahi-browse -at | grep IPv4`
- You can ping `host.local` on the intranet.


## Locale

```
export LANGUAGE=en_US.UTF-8
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8
locale-gen en_US.UTF-8
sudo dpkg-reconfigure locales
```

`localectl set-locale LANG=en_US.utf8`

## Package management

To re-install a package:
```bash
$ sudo apt-get --reinstall install package
```

## NTP

To list NTP servers I use:

```
$ ntpq -p
     remote           refid      st t when poll reach   delay   offset  jitter
==============================================================================
*ks3352891.kimsu 138.96.64.10     2 u   99  128  377   37.876   31.229  24.093
...
```

## SSH

```
ssh-keygen -t rsa -b 4096
ssh-keyscan -H 192.168.0.9 >> known_hosts
```

## ZFS

### Install ZFS

On Linux Mint 19:

```bash
sudo apt-get install zfs-dkms zfsutils-linux
```

Then, to import a pool: `zpool import POOLNAME`

## Firewall

```bash
$ iptables -t nat -F ==> flush the NAT table
```

Redirect an IP address to yourself (or another IP address):

```bash
sudo iptables -t nat -A OUTPUT -p all -d SOURCE-IP -j DNAT --to-destination DEST-IP
```

To remove a rule,

1. List rule number: `sudo iptables -t nat -v -L OUTPUT -n --line-number`
2. Remove the given number: `sudo iptables -t nat -D OUTPUT NUM`

Here OUTPUT refers to the part of iptables to work on


## User management 

### Adding user to group and take into account immediately

1. Add user to new group B.
2. Get the current group of the user:
```bash
$ id -g
```
Let's call that group A.
3. Change group to B:
```bash
$ newgrp B
```
4. Reset back to original group:
```bash
$ newgrp A
```

## Adding udev rules without rebooting

```bash
sudo udevadm control --reload-rules
sudo service udev restart
sudo udevadm trigger
```

## Mate

Specify keyboard bindings in `mate-control-center`

## MDM

To have the correct keyboard in MDM, at the end of `/etc/mdm/Init/Default`, insert:

```
/usr/bin/setxkbmap fr
```


# Sound

## Listing devices

```bash
$ sudo aplay -l
**** List of PLAYBACK Hardware Devices ****
card 0: PCH [HDA Intel PCH], device 0: ALC269VB Analog [ALC269VB Analog]
  Subdevices: 0/1
  Subdevice #0: subdevice #0
card 1: J20 [Jabra EVOLVE 20], device 0: USB Audio [USB Audio]
  Subdevices: 1/1
  Subdevice #0: subdevice #0
```


# Apps

## Mail

d * removes all email
q

## Recording desktop

```
$ gtk-recordmydesktop
```

To stop: Ctrl-Mod-s

## ffmepg

- Get the height and width of a video: `ffmepg -i myvideo.mp4`
- Rescale a video: `ffmpeg -i input.jpg -vf scale=320:-1 output_320.png` (-1 is for keeping aspect ratio for one of the sizes)
- Join to videos side by side: `ffmpeg -i video_1.mp4 -i video_2.mp4 -filter_complex '[0:v][1:v]hstack=2[vid]' -map [vid] -c:v libx264 -crf 22 -preset veryfast output.mp4`
- Crop a video: `ffmpeg -i input.mp4 -vf  "crop=w:h:x:y" input_crop.mp4`
- Put side by side two videos with same height: `ffmpeg -i left.mp4 -i rscaled.ogv -filter_complex '[0:v][1:v]hstack=2[vid]' -map [vid] -c:v libx264 -crf 22 -preset veryfast right.mp4`
- Skip first few seconds of a video: `ffmpeg -ss 00:00:04 ...`
- Inserting text in videos with subtitles: [tuto](https://github.com/Erkaman/ffmpeg-add-text-to-video-tutorial)
- Convert mp4 to flv: `ffmpeg -i source.mp4 -c:v libx264 -crf 19 destinationfile.flv`

Remove between x and y:

- `ffmpeg  -t 00:11:00 -i input.mp4 -map 0 -c copy segment1.mp4`
- `ffmpeg -ss 00:11:10 -i input.mp4 -map 0 -c copy segment2.mp4`

Then create a file:

```
file 'segment1.mp4'
file 'segment2.mp4'
```

Then concatenate:

`ffmpeg -f concat -i input.txt -map 0 -c copy output.mp4`



## Bluez

```bash 
$ wget http://www.kernel.org/pub/linux/bluetooth/bluez-5.20.tar.xz
$ tar -xvf bluez-5.20.tar.xz
$ cd bluez-5.20/
$ sudo apt-get install libudev-dev libical-dev libreadline-dev
$ ./configure –enable-library –disable-systemd
$ make
$ make check
$ sudo make install
$ sudo cp attrib/gatttool /usr/bin/
$sudo cp tools/btmgmt /usr/bin/
```

## Piwigo

[Piwigo gallery on nginx with debian](https://www.howtoforge.com/install-piwigo-gallery-on-nginx-with-debian-wheezy)

```
create database gallery01; grant all on gallery01.* to 'gallery'@'localhost' identified by 'PASSWORD'; flush privileges; \q;
```


## Useful packages (at some point...)

- To install glib2:
```
sudo apt-get install libgtk2.0-dev
```


- To install [Java](http://tecadmin.net/install-oracle-java-8-jdk-8-ubuntu-via-ppa/):

`export JAVA_HOME=/usr/lib/jvm/java-8-oracle`
